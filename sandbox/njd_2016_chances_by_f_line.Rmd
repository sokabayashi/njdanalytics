---
title: "NJD Chances by Line/Pair"
geometry: margin=1cm
output: html_document
fontsize: 10pt
---

```{r Setup knitr, include=FALSE}

knitr::opts_chunk$set(echo=FALSE, warning=FALSE, tidy=TRUE, cache=FALSE, OutDec = ",")
```

```{r Load db and RData, include=F}
library( njdanalytics )

nhl_db <- setup_nhl_db()
player_tbl           <- tbl( nhl_db, "player"           ) %>% collect()
team_score           <- tbl( nhl_db, "team_score"       )
stage_game           <- tbl( nhl_db, "stage_game"       )
stage_roster         <- tbl( nhl_db, "stage_roster"     )
stage_playbyplay     <- tbl( nhl_db, "stage_playbyplay" )
stage_shift_interval <- tbl( nhl_db, "stage_shift_interval" )
game_player          <- tbl( nhl_db, "game_player"      )
team_tbl             <- tbl( nhl_db, "team"             ) %>% collect()

this_season     <- "20152016"
this_session_id <- "2"

# fig directory
fig_dir <- paste0( nhl_dir$base, "/packages/njdanalytics/sandbox/fig/njd2016/f_lines" )

#################################``########################################
# MANUALLY UPDATE
game_suffix <- 82

#########################################################################

# njd_games has game_number and game_id4 to join different data sources
our_team_short  <- "NJD" # might change perspective for games we're not in?
our_team_common <- team_tbl %>% filter( name_short==our_team_short ) %>% select( name_common ) %>% unlist( use.names = F )
our_games       <- team_score %>% 
                          filter( season==this_season, session_id==this_session_id, team_short==our_team_short) %>%
                          collect() %>% arrange( game_date )
our_games            <- add_team_score_label( our_games, our_team=our_team_short ) %>%
                          select( game_date, game_number, season, session_id, game_id4, ha, opp_team_short, game_label )
our_game_id4s        <- our_games$game_id4

# njd_games, shots_tbl, player_chances_df, njd_players_by_game, pair_chances_df
load( file=paste0( nhl_dir$shot, "/njd_through_", game_suffix, ".RData" ))
```


```{r analysis parameters}
this_season     <- "20152016"
this_session_id <- "2"
```

```{r db tables}
rosters      <- stage_roster %>% 
                          filter( season==this_season, session_id==this_session_id, game_id4 %in% our_game_id4s ) %>% collect()
pbp          <- stage_playbyplay %>% 
                          filter( season==this_season, session_id==this_session_id, game_id4 %in% our_game_id4s ) %>% collect()
stage_game   <- stage_game %>% 
                          filter( season==this_season, session_id==this_session_id, game_id4 %in% our_game_id4s ) %>% collect()

# 21.9k rows in our shift interval
stage_shift_interval <- stage_shift_interval %>%
                          filter( season==this_season, session_id==this_session_id, game_id4 %in% our_game_id4s ) %>% collect()
```

```{r shift interval nest}
# Get HA perspective joined
shift_interval_spread <- stage_shift_interval %>% 
    left_join( our_games %>% select( season, game_id4, our_ha=ha ), by=c( "season", "game_id4" ) ) %>% 
    mutate(
      ev5on5    = ifelse( num_skaters_h==5 & num_goalies_h==1 & num_skaters_a==5 & num_goalies_a==1, TRUE, FALSE )
    )

# Gather away_p1_id - home_p6_id columns and convert to rows.
# Each unique time interval with then have multiple rows, one for each on ice player.
shift_interval_gather <- shift_interval_spread %>% gather( player_label, player_id, away_p1_id:home_p6_id ) %>% 
                          filter( !is.na(player_id) ) %>% 
                          left_join(
                            player_tbl %>% select( nhl_id, last_name, position_fd ), by=c( "player_id"="nhl_id" )
                          ) %>% mutate(
                            player_ha = ifelse( grepl( "home", player_label ), "H", "A" )
                          )

# Drop extra columns
# sorting by ID by team ensures unique line representation when we then push into lists
shift_interval_ev <- shift_interval_gather %>% 
    select( -starts_with("away_player"), -starts_with("home_player"), 
            -starts_with( "on_ice"), -ends_with("_skaters"), -ends_with( "_goalie") ) %>% 
    arrange( game_date, start_cum, player_ha, desc(position_fd), player_id ) 
  
shift_interval_group_F_ev <- shift_interval_ev %>% 
    filter( ev5on5, position_fd=="F" ) %>% 
    group_by( game_date, season, session_id, game_id4, period, start_cum, duration, our_ha ) %>% 
    summarise(
                    num_F_h = sum( player_ha=="H" ),
                    num_F_a = sum( player_ha=="A" ),
                    F_id_h_list  = list( player_id[ player_ha=="H"] ),
                    F_h_list     = list( last_name[ player_ha=="H"] ),
                    F_id_a_list  = list( player_id[ player_ha=="A"] ),
                    F_a_list     = list( last_name[ player_ha=="A"] )
  ) 
  
our_shift_interval_F <- shift_interval_group_F_ev %>% 
mutate(
  our_F_id_list = ifelse( our_ha=="H", F_id_h_list, F_id_a_list ),
  our_F_list    = ifelse( our_ha=="H", F_h_list,    F_a_list ),
  our_F_ids   = paste( our_F_id_list %>% unlist(), collapse=" " ),
  our_F_names = paste( our_F_list %>% unlist(), collapse=" " )
) 
    
```

```{r our F toi summary}
# Total EV5on5 TOI for season
# 3874 agrees with our D-men analysis
season_total_toi_ev <- our_shift_interval %>% ungroup() %>% summarise( toi=sum(duration) ) %>% unlist(use.names = F)
season_total_toi_ev
# back of the envelope
82 * 48

our_F_summary <- our_shift_interval %>% ungroup() %>% group_by( our_F_ids, our_F_names ) %>% 
            summarise( toi=sum(duration) ) %>% ungroup() %>% arrange( desc( toi )) %>% filter( toi > 30 ) %>% 
            mutate( toi_pct = round( toi/season_total_toi_ev*100,2 ) )

our_F_summary %>% View

our_F_lines <- our_F_summary %>% select( ids=our_F_ids, names=our_F_names )
```

```{r pbp nest}
event_types_study <- c( "FAC", "BLOCK", "MISS", "SHOT", "GOAL"  ) # , "ICING",  "OFFSIDE", "PENL"

pbp_spread <- pbp %>% 
    filter( event_type %in% event_types_study ) %>% 
    left_join( our_games %>% select( season, game_id4, our_ha=ha ), by=c( "season", "game_id4" ) )

pbp_gather <- pbp_spread %>% 
                gather( player_label, player_id, away_p1_id:home_p6_id ) %>% 
                          filter( !is.na(player_id) ) %>% 
                          left_join(
                            player_tbl %>% select( nhl_id, last_name, position_fd ), by=c( "player_id"="nhl_id" )
                          ) %>% mutate(
                            player_ha = ifelse( grepl( "home", player_label ), "H", "A" )
                          )

# Drop extra columns
# sorting by ID by team ensures unique line representation when we then push into lists
pbp_ev <- pbp_gather %>% 
    select( -starts_with("away_player"), -starts_with("home_player"), 
            -starts_with( "on_ice"), -ends_with("_skaters"), -ends_with( "_goalie") ) %>% 
    arrange( game_date, start_cum, player_ha, desc(position_fd), player_id ) 
  
pbp_group_F_ev <- pbp_ev %>% 
    filter( ev5on5, position_fd=="F" ) %>% 
    group_by( game_date, season, session_id, game_id4, period, start_cum, our_ha, 
              event_type, etext, event_team, event_team_ha, homezone ) %>% 
    summarise(
                    num_F_h = sum( player_ha=="H" ),
                    num_F_a = sum( player_ha=="A" ),
                    F_id_h_list  = list( player_id[ player_ha=="H"] ),
                    F_h_list     = list( last_name[ player_ha=="H"] ),
                    F_id_a_list  = list( player_id[ player_ha=="A"] ),
                    F_a_list     = list( last_name[ player_ha=="A"] )
  ) 
  
our_pbp_F <- pbp_group_F_ev %>% 
mutate(
  our_F_id_list = ifelse( our_ha=="H", F_id_h_list, F_id_a_list ),
  our_F_list    = ifelse( our_ha=="H", F_h_list,    F_a_list ),
  our_F_ids   = paste( our_F_id_list %>% unlist(), collapse=" " ),
  our_F_names = paste( our_F_list %>% unlist(), collapse=" " )
) %>% filter(
  our_F_ids %in% our_F_lines$ids
)

our_pbp_F <- our_pbp_F %>% select( -starts_with( "num") )
```

```{r faceoff}
fac_df <- our_pbp_F %>% ungroup() %>% filter( event_type=="FAC" ) 
fac_df <- fac_df %>% mutate(
  our_zs = ifelse( our_ha=="H", homezone,
                ifelse( homezone=="Def", "Off",
                        ifelse( homezone=="Off", "Def", "Neu" )))
)

fac_summary <- fac_df %>% 
                  group_by( our_F_ids, our_F_names ) %>% 
                  summarize( 
                    zs_o = sum(our_zs=="Off"),
                    zs_n = sum(our_zs=="Neu"),
                    zs_d = sum(our_zs=="Def"),
                    zs_o_pct = round( zs_o / (zs_o + zs_d ), 3 ),
                    fo_w = sum(event_team == our_team_short),
                    fo_l = sum(event_team != our_team_short),
                    fo_count = fo_w + fo_l,
                    fo_pct   = round( fo_w / fo_count, 3 )
                    )

```

```{r corsi}
shot_df <- our_pbp_F %>% ungroup() %>% filter( event_type %in% c( "BLOCK", "MISS", "SHOT", "GOAL") ) 

shot_summary <- shot_df %>% 
                  group_by( our_F_ids, our_F_names ) %>% 
                  summarize( 
                    cf = sum( event_team == our_team_short ),
                    ca = sum( event_team != our_team_short ),
                    
                    fo_count = fo_w + fo_l,
                    fo_pct   = round( fo_w / fo_count, 3 )
                    )
```






```{r NJD F pair summary}
njd_team_gp_ev$toi %>% sum()

defensemen_h2h_ev <- njd_h2h_ev %>% filter( position_fd_1=="D", position_fd_2=="D" ) %>% arrange(
                                    desc(toi_1), desc(toi)
) %>% select( -matches("position|team_comp|faceoff|is|fo|num|rank|team_short|shoots"))

defensemen_gp_ev <- defensemen_h2h_ev %>% group_by( nhl_id_1, last_name_1, toi_1 ) %>% mutate(
                      toi_pct          = round( toi / first(toi) * 100, 1),
                      toi_wo           = toi - first(toi),  
                      cf_wo            = cf -  first(cf),
                      ca_wo            = ca -  first(ca),
                      c_net_wo         = c_net - first(c_net),
                      green_net_wo     = green_net - first(green_net),
                      blue_net_wo      = blue_net - first(blue_net),
                      greenblue_f_wo   = greenblue_f - first(greenblue_f),
                      greenblue_a_wo   = greenblue_a - first(greenblue_a),
                      greenblue_net_wo = greenblue_net - first(greenblue_net),
                      c_net_60_wo      = round( c_net  / toi_wo * 60, 3 ),
                      c_net_60_wowy    = c_net_60 - c_net_60_wo,
                      green_net_60_wo  = round( green_net  / toi_wo * 60, 3 ),
                      green_net_60_wowy= green_net_60 - green_net_60_wo,
                      blue_net_60_wo   = round( blue_net  / toi_wo * 60, 3 ),
                      blue_net_60_wowy = blue_net_60 - blue_net_60_wo,
                      greenblue_net_60_wo = round( greenblue_net  / toi_wo * 60, 3 ),
                      greenblue_net_60_wowy = greenblue_net_60 - greenblue_net_60_wo,
                      greenblue_f_pct_wo  = round( greenblue_f_wo / cf_wo * 100, 3 ),
                      greenblue_a_pct_wo  = round( greenblue_a_wo / ca_wo * 100, 3 )
)

write_csv( defensemen_gp_ev, path=paste0(fig_dir, "/njd_d_pairs.csv" ))
```












